{% load static %}

<div class="flex-fill">
  <p class="m-0 p-0 text-center">Physical activity over time</p>
  <div id="activity-heatmap"></div>
</div>

<script>
  function redrawActivityHeatmap() {
    const heatmapEl = $('#activity-heatmap');

    // Labels of row and columns
    const weeks = ["A", "B", "C", "D", "E", "F", "G", "H", "I", "J", "K"];
    const weekdays = ["Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"].reverse();

    // set the dimensions and margins of the graph
    const margin = { top: 10, right: 30, bottom: 0, left: 30 },
      width = heatmapEl.width() - margin.left - margin.right,
      height = heatmapEl.width() * weekdays.length / weeks.length - margin.top - margin.bottom;

    // append the svg object to the body of the page
    const svg = d3.select("#activity-heatmap")
      .append("svg")
      .attr("width", width + margin.left + margin.right)
      .attr("height", height + margin.top + margin.bottom)
      .append("g")
      .attr("transform",
        "translate(" + margin.left + "," + margin.top + ")");

    // Build X scale:
    const x = d3.scaleBand()
      .range([0, width])
      .domain(weeks)
      .padding(0);

    // Build Y scale and axis:
    const y = d3.scaleBand()
      .range([height, 0])
      .domain(weekdays)
      .padding(0);
    svg.append("g")
      .call(d3.axisLeft(y).tickSize(0));

    // Build color scale
    const myColor = d3.scaleLinear()
      .range(["#ebedf0", "#216e39"])
      .domain([1, 100]);

    // Read the data
    d3.csv("{% static 'heatmap_data.csv' %}", data => {
      svg.selectAll()
        .data(data, function (d) { return d.group + ':' + d.variable; })
        .enter()
        .append("rect")
        .attr("x", function (d) { return x(d.group) })
        .attr("y", function (d) { return y(d.variable) })
        .attr("width", x.bandwidth())
        .attr("height", y.bandwidth())
        .style("fill", function (d) { return myColor(d.value) });
    });
  }

  redrawActivityHeatmap();
</script>
