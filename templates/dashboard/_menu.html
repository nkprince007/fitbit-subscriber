<style>
  .menu {
    padding: 0 1rem;
  }

  .patients-info-table {
    table-layout: fixed;
  }

  #global-config-form {
    padding-bottom: 1rem;
  }

  .search-form-group {
    display: flex;
    justify-content: center;
    align-items: flex-end;
    margin-bottom: 1rem;
  }

  .search-form-group .form-group {
    flex: 1;
    margin-bottom: 0;
  }

  .search-form-group .submit-button {
    margin-left: 1rem;
  }
</style>

<div class="menu d-flex flex-column">
  <form id="global-config-form" method="GET" action="" class="">
    <div class="search-form-group">
      <div class="form-group">
        <label for="global-search">Patient search</label>
        <input
          class="form-control flex-fill"
          type="search"
          placeholder="Search"
          aria-label="Search"
          id="global-search"
          name="patientId"
          autocomplete="off"
          data-provide="typeahead"
        />
      </div>
      <div class="submit-button">
        <button type="submit" class="btn btn-primary mx-auto">
          <i class="fa fa-search" aria-hidden="true"></i>
        </button>
      </div>
    </div>
    <div class="form-group">
      <label for="global--time-period-selector">Time period</label>
      <select
        name="period"
        class="form-control"
        id="global--time-period-selector"
      >
        <option value="7">Last week</option>
        <option value="14">Last 2 weeks</option>
        <option value="30">Last month</option>
        <option value="60">Last 2 months</option>
        <!-- <option value="90">Last 3 months</option> -->
      </select>
    </div>
  </form>

  <div class="mt-3" id="patients-info">
    <table
      class="card patients-info-table table table-light"
      id="patient-details"
    >
      <thead>
        <tr>
          <th class="m-0 p-0">
            <h6 class="m-2">Patient Details</h6>
          </th>
        </tr>
      </thead>
      <tbody>
        <tr class="py-0">
          <th class="py-1" scope="row">Name</th>
          <td id="patient--name" class="text-capitalize py-1"></td>
        </tr>
        <tr class="py-0">
          <th class="py-1" scope="row">Age</th>
          <td id="patient--age" class="text-capitalize py-1"></td>
        </tr>
        <tr class="py-0">
          <th class="py-1" scope="row">Sex</th>
          <td id="patient--sex" class="text-capitalize py-1"></td>
        </tr>
      </tbody>
    </table>

    {% include 'dashboard/activity/_activity_index_summary.html' %}
  </div>
</div>

<script>
  let globalConfigForm;
  let globalSearchInput;
  let globalPeriodInput;
  let globalLoading;
  let globalPatientIds;

  const substringMatcher = (strings) => {
    return function findMatches(q, cb) {
      const substringRegex = new RegExp(q, 'i');
      const matches = strings.filter(str => substringRegex.test(str));
      cb(matches);
    };
  };

  const choosePatient = (patientId) => {
    globalSearchInput.val(patientId);
    globalConfigForm.submit();
  };

  const choosePeriod = (period) => {
    globalConfigForm.submit();
  }

  const configureForm = async () => {
    globalLoading = true;
    try {
      const data = Object.fromEntries(new URLSearchParams(window.location.search.replace('?', '')));
      let patientId;

      if (!!data['patientId']) {
        globalSearchInput.val(data['patientId']);
        patientId = data['patientId'];
      } else {
        globalSearchInput.val($(btn).data('patientId'));
        globalConfigForm.submit();
      }

      if (!!data['period']) {
        globalPeriodInput.val(data['period']);
      }

      await populatePatientDetails(patientId);
    } catch (err) {
      console.warn(err);
    }
    globalLoading = false;
  }

  const addListeners = () => {
    globalPeriodInput.change(function (event) {
      choosePeriod(event.target.value);
    });

    configureForm();
  }

  const populatePatientDetails = async (patientId) => {
    if (!patientId) return;
    const sexEl = $('#patient--sex');
    const nameEl = $('#patient--name');
    const ageEl = $('#patient--age');

    // TODO: fetch real patient data here
    const patient = (await axios({
      method: 'post',
      data: {patientId},
      url: "{% url 'patient_details' %}",
    })).data;
    const title = patient.sex.toLowerCase() === 'male' ? "Mr" : 'Mrs'
    nameEl.text(`${title}. ${patient.name}`);
    ageEl.text(patient.age);
    sexEl.text(patient.sex);

    const data = {
      patientId: parseInt(patientId, 10),
      period: globalPeriodInput.val(),
    };
    redrawActivityHeatmap(data);
    redrawActivityZones(data);
    redrawNutritionBarPlots(data);
    redrawActivityMetrics(data);
    redrawBodyWeightFatCharts(data);
  }

  const populatePatients = (patients) => {
    globalSearchInput.typeahead({
      hint: true,
      highlight: true,
      minLength: 1,
    }, {
      name: 'patients',
      source: substringMatcher(globalPatientIds),
    }).bind("typeahead:selected", (event, value) => {
      choosePatient(value);
    });
    $('.search-form-group .form-group .twitter-typeahead')
      .css({display: 'block'});
    addListeners();
  }

  $(document).ready(async function () {
    $.fn.filterByData = function(prop, val) {
      return this.filter(
        function() { return $(this).data(prop)==val; }
      );
    };

    globalConfigForm = $('#global-config-form');
    globalSearchInput = $('#global-search');
    globalPeriodInput = $("#global--time-period-selector");

    const patientIds = (await axios({
      method: 'get',
      url: "{% url 'patient_ids' %}",
    })).data;
    globalPatientIds = patientIds;

    populatePatients(patientIds.map((id) => ({id})));
  });
</script>
